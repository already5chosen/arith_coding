#include <stdint.h>
#include <stdio.h>
#include <math.h>

static const uint8_t tab1i[64] = {
 255, 248, 240, 233,
 225, 218, 212, 205,
 199, 192, 186, 180,
 175, 169, 164, 158,
 153, 148, 143, 138,
 134, 129, 125, 120,
 116, 112, 108, 104,
 100, 96 , 92 , 88 ,
 85 , 81 , 78 , 74 ,
 71 , 68 , 65 , 62 ,
 59 , 56 , 53 , 50 ,
 47 , 44 , 41 , 39 ,
 36 , 33 , 31 , 28 ,
 26 , 24 , 21 , 19 ,
 17 , 14 , 12 , 10 ,
 8  , 6  , 4  , 2  ,
};

static const uint32_t tab1[64] = {
 536870912  , 682398916  , 937091716  , 1103362014 ,
 1382486880 , 1570799997 , 1664072623 , 1872638678 ,
 1983759008 , 2213741774 , 2343750303 , 2482852922 ,
 2516421264 , 2672857097 , 2721242383 , 2895923748 ,
 2959916243 , 3031281479 , 3110202637 , 3196869810 ,
 3164538868 , 3265651333 , 3245145759 , 3361388697 ,
 3353276123 , 3350864557 , 3354278275 , 3363645664 ,
 3379099398 , 3400776639 , 3428819239 , 3463373953 ,
 3359437008 , 3405756636 , 3310825865 , 3369405046 ,
 3283863116 , 3202468219 , 3125297270 , 3052429348 ,
 2983945771 , 2919930186 , 2860468654 , 2805649749 ,
 2755564656 , 2710307269 , 2669974306 , 2466913573 ,
 2435010941 , 2408305329 , 2214485088 , 2196683046 ,
 2008902480 , 1823597751 , 1818795892 , 1639837179 ,
 1463481486 , 1472347728 , 1302668303 , 1135729139 ,
 971571443  , 810237358  , 651769995  , 496213457  ,
};

static const double poly_tab[4] = {
  -0.350964418702816,   0.480791924089072,  -0.721347115690035,   1.442695040541489
};
double fast_log2(uint32_t x)
{
  int prt = x==113;
  // static const double POW2_31 = (uint32_t)1 << 31;
  static const double INV_POW2_31 = 1.0/ ((uint32_t)1 << 31);
  static const double INV_POW2_35 = 1.0/16.0/((uint32_t)1 << 31);
  int lz = __builtin_clz(x);
  x <<= lz;
  uint32_t idx1 = (x >> 25) & 63;
  uint32_t x2 = ((uint64_t)x * (tab1i[idx1] + 257)) >> 9;
  // double res = idx1*(1.0/64) + tab1[idx1]*INV_POW2_35;
  double res = (((int64_t)idx1 << 29) - (1<<29) + tab1[idx1])*INV_POW2_35;
  double dx = (x2 - ((uint32_t)1 << 31))*INV_POW2_31;
  double polyval = (((poly_tab[0]*dx + poly_tab[1])*dx) + poly_tab[2])*dx + poly_tab[3];
  res += polyval*dx;
  // res += (x2 - ((uint32_t)1 << 31)) * 6.71807229932846e-010;
  
  // if (prt) {
    // printf("x = %08x idx1=%u ti=%d xx=%011I64x\n", x, idx1, tab1i[idx1] + 257, (uint64_t)x * (tab1i[idx1] + 257));
  // }
  
  
  return 31 - lz + res;
  // return 31 - lz + (x*INV_POW2_31 - 1.0);
}