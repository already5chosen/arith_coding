#include <stdint.h>
#include <stdio.h>
#include <math.h>

static const uint8_t tab1i[128] = {
 255, 252, 248, 244, 240, 236, 233, 229,
 225, 222, 218, 215, 212, 208, 205, 202,
 199, 195, 192, 189, 186, 183, 180, 178,
 175, 172, 169, 166, 164, 161, 158, 156,
 153, 151, 148, 146, 143, 141, 138, 136,
 134, 131, 129, 127, 125, 122, 120, 118,
 116, 114, 112, 110, 108, 106, 104, 102,
 100, 98 , 96 , 94 , 92 , 90 , 88 , 87 ,
 85 , 83 , 81 , 80 , 78 , 76 , 74 , 73 ,
 71 , 70 , 68 , 66 , 65 , 63 , 62 , 60 ,
 59 , 57 , 56 , 54 , 53 , 51 , 50 , 48 ,
 47 , 46 , 44 , 43 , 41 , 40 , 39 , 37 ,
 36 , 35 , 33 , 32 , 31 , 30 , 28 , 27 ,
 26 , 25 , 24 , 22 , 21 , 20 , 19 , 18 ,
 17 , 15 , 14 , 13 , 12 , 11 , 10 , 9  ,
 8  , 7  , 6  , 5  , 4  , 3  , 2  , 1  ,
};

static const uint32_t tab1[128] = {
  268435456 ,  291307151 ,  413963460 ,  539729876 ,
  668656260 ,  800793684 ,  834926558 ,  972809969 ,
 1114051424 , 1155110985 , 1302364541 , 1347999560 ,
 1395637167 , 1551792094 , 1604203222 , 1658704570 ,
 1715323552 , 1883636508 , 1945306318 , 2009189140 ,
 2075314847 , 2143713920 , 2214417466 , 2173370593 ,
 2247985808 , 2324991640 , 2404421641 , 2486310075 ,
 2452806927 , 2538870889 , 2627488292 , 2598524916 ,
 2691480787 , 2665444954 , 2762846023 , 2739810198 ,
 2841767181 , 2821806551 , 2928434354 , 2911626972 ,
 2896103412 , 3009471827 , 2997215877 , 2986290736 ,
 2976710303 , 3099109650 , 3092953241 , 3088191939 ,
 3084840667 , 3082914584 , 3082429101 , 3083399874 ,
 3085842819 , 3089774115 , 3095210208 , 3102167816 ,
 3110663942 , 3120715871 , 3132341183 , 3145557759 ,
 3160383783 , 3176837755 , 3194938497 , 3070394649 ,
 3091001552 , 3113303728 , 3137321180 , 3015761755 ,
 3042390409 , 3070785925 , 3100969590 , 2982521008 ,
 3015427660 , 2898353006 , 2934032763 , 2971589786 ,
 2856861814 , 2897278598 , 2783993892 , 2827324396 ,
 2715510315 , 2761810038 , 2651494730 , 2700820773 ,
 2592033198 , 2644444326 , 2537214293 , 2592770998 ,
 2487129200 , 2382023790 , 2441871813 , 2338396989 ,
 2401538850 , 2299727498 , 2198478117 , 2266115976 ,
 2166575485 , 2067612413 , 2139869873 , 2042662995 ,
 1946049632 , 1850033912 , 1928247590 , 1834050008 ,
 1740467024 , 1647502987 , 1555162295 , 1640804232 ,
 1550360436 , 1460558053 , 1371401723 , 1282896134 ,
 1195046030 , 1289766954 , 1203912272 , 1118732567 ,
 1034232847 , 950418179  , 867293683  , 784864540  ,
 703135987  , 622113322  , 541801902  , 462207148  ,
 383334539  , 305189620  , 227778001  , 151105353  ,
};

// Polynomial [4.7426400781261968120e-1 -7.2131043670720895733e-1 1.4426949818690479876 0]
static const double poly0_tab[] = { 0.47426400781261968120 };
static const double poly2_tab[] = { -1.5209048648536631632, 3.0419659896246069586 };
double fast_log2(uint32_t x)
{
  static const double INV_POW2_35 = 1.0/ ((int64_t)1 << 35);
  static const double INV_POW2_40 = 1.0/ ((int64_t)1 << 40);
  int lz = __builtin_clz(x);
  int64_t iRes = (uint64_t)(31 - lz) << 35; // integer part of result, scaled by 2^35
  x <<= lz;
  uint32_t idx1 = (x >> 24) & 127;
  int64_t x2 = (uint64_t)x * (tab1i[idx1] + 257);

  iRes += (uint64_t)idx1 << 28;
  iRes -= (uint64_t)1    << 28;
  iRes += tab1[idx1];
  double res = iRes*INV_POW2_35;
  double dx  = (x2 - ((int64_t)1 << 40))*INV_POW2_40;
  double polyval0 = dx * poly0_tab[0];
  double polyval2 = (dx + poly2_tab[0]) * dx + poly2_tab[1];
  double polyval = polyval0*polyval2;
  res += polyval;

  return res;
}
