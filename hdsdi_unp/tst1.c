#include <stdint.h>
#include <stdio.h>
#include <stdlib.h>
#include <malloc.h>
#include <string.h>
#include <immintrin.h>

static void unpack_ref(uint64_t*,uint64_t*,uint64_t*, const uint64_t*, int nLines);
// static 
void unpack(uint64_t*,uint64_t*,uint64_t*, const uint64_t*, int nLines);
static void pp(const void* a,const void* b);

int main(void)
{
  const int srcSz = (1920*1080*20)/8;
  const int dstSz = 1920*1080;
  uint64_t* src   = _aligned_malloc(srcSz, 64);
  uint64_t* dst0a = _aligned_malloc(dstSz, 64);
  uint64_t* dst1a = _aligned_malloc(dstSz, 64);
  uint64_t* dst2a = _aligned_malloc(dstSz, 64);
  uint64_t* dst0b = _aligned_malloc(dstSz, 64);
  uint64_t* dst1b = _aligned_malloc(dstSz, 64);
  uint64_t* dst2b = _aligned_malloc(dstSz, 64);

  if (src==0)    return 1;
  if (dst0a==0)  return 1;
  if (dst1a==0)  return 1;
  if (dst2a==0)  return 1;
  if (dst0b==0)  return 1;
  if (dst1b==0)  return 1;
  if (dst2b==0)  return 1;

  srand(1);
  for (int i = 0; i < srcSz/8; ++i) {
    uint64_t w = rand();
    w ^= (uint64_t)rand() << 13;
    w ^= (uint64_t)rand() << 26;
    w ^= (uint64_t)rand() << 39;
    w ^= (uint64_t)rand() << 52;
    src[i] = w;
  }

  unpack_ref(dst0a, dst1a, dst2a, src, 1080);

  memset(dst0b, 'a', dstSz);
  memset(dst1b, 'b', dstSz);
  memset(dst2b, 'c', dstSz);
  unpack(dst0b, dst1b, dst2b, src, 1080);

  if (memcmp(dst1a, dst1b, dstSz) != 0) {
    printf("field 1 fail\n");
    pp(dst1a, dst1b);
    return 1;
  }
  if (memcmp(dst2a, dst2b, dstSz) != 0) {
    printf("field 2 fail\n");
    pp(dst2a, dst2b);
    return 1;
  }
  if (memcmp(dst0a, dst0b, dstSz) != 0) {
    printf("field 0 fail\n");
    pp(dst0a, dst0b);
    return 1;
  }
  printf("o.k");
  return 0;
}

static void unpack_ref(uint64_t* dst0, uint64_t* dst1, uint64_t* dst2, const uint64_t* src, int nLines)
{
  int ni = nLines * 1920 / 2; // 2 pixels per iteration
  uint8_t* srcb = (uint8_t*)src;
  for (int i = 0; i < ni; ++i, srcb += 5) {
    uint32_t YCb;
    memcpy(&YCb, srcb, sizeof(YCb));
    uint8_t Cr = srcb[4];
    YCb >>= 2;
    uint8_t Y0 = YCb;
    YCb >>= 10;
    uint8_t Cb = YCb;
    YCb >>= 10;
    uint8_t Y1 = YCb;
    ((uint8_t*)dst0)[i*2+0] = Y0;
    ((uint8_t*)dst0)[i*2+1] = Y1;
    ((uint8_t*)dst1)[i*2+0] = Cb;
    ((uint8_t*)dst1)[i*2+1] = Cb;
    ((uint8_t*)dst2)[i*2+0] = Cr;
    ((uint8_t*)dst2)[i*2+1] = Cr;
  }
}

// static 
void unpack(uint64_t* dst0, uint64_t* dst1, uint64_t* dst2, const uint64_t* src, int nLines)
{
  int ni = nLines * 1920 / 32; // 32 pixels per iteration
  for (int i = 0; i < ni; ++i, src += 10) {
    __m128i s0, s1, s2, s3, s4;
    memcpy(&s0, &src[0], sizeof(__m128i));
    // bits| 15  14  13  12  11  10  09  08  07  06  05  04  03  02  01  00 |
    //   15|---------Cb0[5:0]------|-----------------Y0[9:0]----------------| 0
    //   31|Cr0[1:0]|-----------------Y1[9:0]--------------|----Cb0[9:6]----| 16
    //   47|-------------Y2[7:0]-----------|---------Cr0[9:2]---------------| 32
    //   63|-----Y3[3:0]---|-----------------Cb2[9:0]--------------|-Y2[9:8]| 48
    //   79|-----------------Cr2[9:0]--------------|---------Y3[9:4]--------| 64
    //   95|---------Cb4[5:0]------|-----------------Y4[9:0]----------------| 80
    //  111|Cr4[1:0]|-----------------Y5[9:0]--------------|----Cb4[9:6]----| 96
    //  127|-------------Y6[7:0]-----------|---------Cr4[9:2]---------------| 112
    memcpy(&s1, &src[2], sizeof(__m128i));
    // bits| 15  14  13  12  11  10  09  08  07  06  05  04  03  02  01  00 |
    //   15|-----Y7[3:0]---|-----------------Cb6[9:0]--------------|-Y6[9:8]| 0
    //   31|-----------------Cr6[9:0]--------------|---------Y7[9:4]--------| 16
    //   47|---------Cb8[5:0]------|-----------------Y8[9:0]----------------| 32
    //   63|Cr8[1:0]|-----------------Y9[9:0]--------------|----Cb8[9:6]----| 48
    //   79|-------------Y10[7:0]----------|---------Cr8[9:2]---------------| 64
    //   95|-----Y11[3:0]--|----------------Cb10[9:0]--------------|Y10[9:8]| 80
    //  111|-----------------Cr10[9:0]-------------|--------Y11[9:4]--------| 96
    //  127|---------Cb12[5:0]-----|-----------------Y12[9:0]---------------| 112
    memcpy(&s2, &src[4], sizeof(__m128i));
    // bits| 15  14  13  12  11  10  09  08  07  06  05  04  03  02  01  00 |
    //   15|Cr12[1:0|----------------Y13[9:0]--------------|---Cb12[9:6]----| 0
    //   31|-------------Y14[7:0]----------|---------Cr12[9:2]--------------| 16
    //   47|-----Y15[3:0]--|----------------Cb14[9:0]--------------|Y14[9:8]| 32
    //   63|-----------------Cr14[9:0]-------------|--------Y15[9:4]--------| 48
    //   79|---------Cb16[5:0]-----|-----------------Y16[9:0]---------------| 64
    //   95|Cr16[1:0|----------------Y17[9:0]--------------|---Cb16[9:6]----| 80
    //  111|-------------Y18[7:0]----------|---------Cr16[9:2]--------------| 96
    //  127|-----Y19[3:0]--|----------------Cb18[9:0]--------------|Y18[9:8]| 112

    __m128i ss0 = s0;
    __m128i ss1l = _mm_bsrli_si128(s0, 10);
    // bits| 15  14  13  12  11  10  09  08  07  06  05  04  03  02  01  00 |
    //   15|---------Cb4[5:0]------|-----------------Y4[9:0]----------------| 0
    //   31|Cr4[1:0]|-----------------Y5[9:0]--------------|----Cb4[9:6]----| 16
    //   47|-------------Y6[7:0]-----------|---------Cr4[9:2]---------------| 32
    //   63|---------------------------00-----------------------------------| 48
    //   79|---------------------------00-----------------------------------| 64
    //   95|---------------------------00-----------------------------------| 80
    //  111|---------------------------00-----------------------------------| 96
    //  127|---------------------------00-----------------------------------| 112
    __m128i ss1h = _mm_bslli_si128(s1, 6);
    // bits| 15  14  13  12  11  10  09  08  07  06  05  04  03  02  01  00 |
    //   15|---------------------------00-----------------------------------| 0
    //   31|---------------------------00-----------------------------------| 16
    //   47|---------------------------00-----------------------------------| 32
    //   63|-----Y7[3:0]---|-----------------Cb6[9:0]--------------|-Y6[9:8]| 48
    //   79|-----------------Cr6[9:0]--------------|---------Y7[9:4]--------| 64
    //   95|---------Cb8[5:0]------|-----------------Y8[9:0]----------------| 80
    //  111|Cr8[1:0]|-----------------Y9[9:0]--------------|----Cb8[9:6]----| 96
    //  127|-------------Y10[7:0]----------|---------Cr8[9:2]---------------| 112
    __m128i ss1  = _mm_castps_si128(_mm_or_ps(_mm_castsi128_ps(ss1l), _mm_castsi128_ps(ss1h)));
    // bits| 15  14  13  12  11  10  09  08  07  06  05  04  03  02  01  00 |
    //   15|---------Cb4[5:0]------|-----------------Y4[9:0]----------------| 0
    //   31|Cr4[1:0]|-----------------Y5[9:0]--------------|----Cb4[9:6]----| 16
    //   47|-------------Y6[7:0]-----------|---------Cr4[9:2]---------------| 32
    //   63|-----Y7[3:0]---|-----------------Cb6[9:0]--------------|-Y6[9:8]| 48
    //   79|-----------------Cr6[9:0]--------------|---------Y7[9:4]--------| 64
    //   95|---------Cb8[5:0]------|-----------------Y8[9:0]----------------| 80
    //  111|Cr8[1:0]|-----------------Y9[9:0]--------------|----Cb8[9:6]----| 96
    //  127|-------------Y10[7:0]----------|---------Cr8[9:2]---------------| 112
    __m128i ss2 = _mm_bsrli_si128(s1, 4);
    // bits| 15  14  13  12  11  10  09  08  07  06  05  04  03  02  01  00 |
    //   15|---------Cb8[5:0]------|-----------------Y8[9:0]----------------| 0
    //   31|Cr8[1:0]|-----------------Y9[9:0]--------------|----Cb8[9:6]----| 16
    //   47|-------------Y10[7:0]----------|---------Cr8[9:2]---------------| 32
    //   63|-----Y11[3:0]--|----------------Cb10[9:0]--------------|Y10[9:8]| 48
    //   79|-----------------Cr10[9:0]-------------|--------Y11[9:4]--------| 64
    //   95|---------Cb12[5:0]-----|-----------------Y12[9:0]---------------| 80
    //  111|---------------------------00-----------------------------------| 96
    //  127|---------------------------00-----------------------------------| 112
    __m128i ss3l = _mm_bsrli_si128(s1, 14);
    // bits| 15  14  13  12  11  10  09  08  07  06  05  04  03  02  01  00 |
    //   15|---------Cb12[5:0]-----|-----------------Y12[9:0]---------------| 0
    //   31|---------------------------00-----------------------------------| 16
    //   47|---------------------------00-----------------------------------| 32
    //   63|---------------------------00-----------------------------------| 48
    //   79|---------------------------00-----------------------------------| 64
    //   95|---------------------------00-----------------------------------| 80
    //  111|---------------------------00-----------------------------------| 96
    //  127|---------------------------00-----------------------------------| 112
    __m128i ss3h = _mm_bslli_si128(s2, 2);
    // bits| 15  14  13  12  11  10  09  08  07  06  05  04  03  02  01  00 |
    //   15|---------------------------00-----------------------------------| 0
    //   31|Cr12[1:0|----------------Y13[9:0]--------------|---Cb12[9:6]----| 16
    //   47|-------------Y14[7:0]----------|---------Cr12[9:2]--------------| 32
    //   63|-----Y15[3:0]--|----------------Cb14[9:0]--------------|Y14[9:8]| 48
    //   79|-----------------Cr14[9:0]-------------|--------Y15[9:4]--------| 64
    //   95|---------Cb16[5:0]-----|-----------------Y16[9:0]---------------| 80
    //  111|Cr16[1:0|----------------Y17[9:0]--------------|---Cb16[9:6]----| 96
    //  127|-------------Y18[7:0]----------|---------Cr16[9:2]--------------| 112
    __m128i ss3 = _mm_castps_si128(_mm_or_ps(_mm_castsi128_ps(ss3l), _mm_castsi128_ps(ss3h)));

    static const uint8_t SS_IDX0[16] = {0,1,2,3, 5,6,7,8, 1,2,  6,7, 4,4, 9,9};
    static const uint8_t SS_IDX1[16] = {1,2,  6,7, 4,4, 9,9, 0,1,2,3, 5,6,7,8};
    __m128i ssIdx0, ssIdx1;
    memcpy(&ssIdx0, SS_IDX0, sizeof(__m128i));
    memcpy(&ssIdx1, SS_IDX1, sizeof(__m128i));
    ss0 = _mm_shuffle_epi8(ss0, ssIdx0);
    // bits| 15  14  13  12  11  10  09  08  07  06  05  04  03  02  01  00 |
    //   15|---------Cb0[5:0]------|-----------------Y0[9:0]----------------| 0
    //   31|Cr0[1:0]|-----------------Y1[9:0]--------------|----Cb0[9:6]----| 16
    //   47|---------Cb2[5:0]------|-----------------Y2[9:0]----------------| 32
    //   63|Cr2[1:0]|-----------------Y3[9:0]--------------|----Cb2[9:6]----| 48
    //   79|------Y1[3:0]--|----------------Cb0[9:0]---------------|-Y0[9:8]| 64
    //   95|------Y3[3:0]--|----------------Cb2[9:0]---------------|-Y2[9:8]| 80
    //  111|---------Cr0[9:2]--------------|---------Cr0[9:2]---------------| 96
    //  127|---------Cr2[9:2]--------------|---------Cr2[9:2]---------------| 112
    ss1 = _mm_shuffle_epi8(ss1, ssIdx1);
    // bits| 15  14  13  12  11  10  09  08  07  06  05  04  03  02  01  00 |
    //   15|------Y5[3:0]--|----------------Cb4[9:0]---------------|-Y4[9:8]| 0
    //   31|------Y7[3:0]--|----------------Cb6[9:0]---------------|-Y6[9:8]| 16
    //   47|---------Cr4[9:2]--------------|---------Cr4[9:2]---------------| 32
    //   63|---------Cr6[9:2]--------------|---------Cr6[9:2]---------------| 48
    //   79|---------Cb4[5:0]------|-----------------Y4[9:0]----------------| 64
    //   95|Cr4[1:0]|-----------------Y5[9:0]--------------|----Cb4[9:6]----| 80
    //  111|---------Cb6[5:0]------|-----------------Y6[9:0]----------------| 96
    //  127|Cr6[1:0]|-----------------Y7[9:0]--------------|----Cb6[9:6]----| 112
    ss2 = _mm_shuffle_epi8(ss2, ssIdx0);
    // bits| 15  14  13  12  11  10  09  08  07  06  05  04  03  02  01  00 |
    //   15|---------Cb8[5:0]------|-----------------Y8[9:0]----------------| 0
    //   31|Cr8[1:0]|-----------------Y9[9:0]--------------|----Cb8[9:6]----| 16
    //   47|--------Cb10[5:0]------|----------------Y10[9:0]----------------| 32
    //   63|Cr10[1:0|-----------------Y11[9:0]-------------|---Cb10[9:6]----| 48
    //   79|----Y9[3:0]----|----------------Cb8[9:0]---------------|-Y8[9:8]| 64
    //   95|----Y11[3:0]---|----------------Cb10[9:0]--------------|Y10[9:8]| 80
    //  111|---------Cr8[9:2]--------------|---------Cr8[9:2]---------------| 96
    //  127|---------Cr10[9:2]-------------|---------Cr10[9:2]--------------| 112
    ss3 = _mm_shuffle_epi8(ss3, ssIdx1);
    // bits| 15  14  13  12  11  10  09  08  07  06  05  04  03  02  01  00 |
    //   15|----Y5[3:0]----|---------------Cb12[9:0]---------------|Y12[9:8]| 0
    //   31|----Y15[3:0]---|---------------Cb14[9:0]---------------|Y14[9:8]| 16
    //   47|---------Cr12[9:2]-------------|---------Cr12[9:2]--------------| 32
    //   63|---------Cr14[9:2]-------------|---------Cr14[9:2]--------------| 48
    //   79|--------Cb12[5:0]------|----------------Y12[9:0]----------------| 64
    //   95|Cr12[1:0|----------------Y13[9:0]--------------|---Cb12[9:6]----| 80
    //  111|--------Cb14[5:0]------|----------------Y14[9:0]----------------| 96
    //  127|Cr14[1:0|----------------Y15[9:0]--------------|---Cb14[9:6]----| 112

    __m128i Y0    = _mm_blend_epi16(ss0, ss1, 0xF0);
    // bits| 15  14  13  12  11  10  09  08  07  06  05  04  03  02  01  00 |
    //   15|---------Cb0[5:0]------|-----------------Y0[9:0]----------------| 0
    //   31|Cr0[1:0]|-----------------Y1[9:0]--------------|----Cb0[9:6]----| 16
    //   47|---------Cb2[5:0]------|-----------------Y2[9:0]----------------| 32
    //   63|Cr2[1:0]|-----------------Y3[9:0]--------------|----Cb2[9:6]----| 48
    //   79|---------Cb4[5:0]------|-----------------Y4[9:0]----------------| 64
    //   95|Cr4[1:0]|-----------------Y5[9:0]--------------|----Cb4[9:6]----| 80
    //  111|---------Cb6[5:0]------|-----------------Y6[9:0]----------------| 96
    //  127|Cr6[1:0]|-----------------Y7[9:0]--------------|----Cb6[9:6]----| 112
    __m128i CbCr0 = _mm_blend_epi16(ss0, ss1, 0x0F);
    // bits| 15  14  13  12  11  10  09  08  07  06  05  04  03  02  01  00 |
    //   15|------Y5[3:0]--|----------------Cb4[9:0]---------------|-Y4[9:8]| 0
    //   31|------Y7[3:0]--|----------------Cb6[9:0]---------------|-Y6[9:8]| 16
    //   47|---------Cr4[9:2]--------------|---------Cr4[9:2]---------------| 32
    //   63|---------Cr6[9:2]--------------|---------Cr6[9:2]---------------| 48
    //   79|------Y1[3:0]--|----------------Cb0[9:0]---------------|-Y0[9:8]| 64
    //   95|------Y3[3:0]--|----------------Cb2[9:0]---------------|-Y2[9:8]| 80
    //  111|---------Cr0[9:2]--------------|---------Cr0[9:2]---------------| 96
    //  127|---------Cr2[9:2]--------------|---------Cr2[9:2]---------------| 112
    __m128i Y1    = _mm_blend_epi16(ss2, ss3, 0xF0);
    // bits| 15  14  13  12  11  10  09  08  07  06  05  04  03  02  01  00 |
    //   15|---------Cb8[5:0]------|-----------------Y8[9:0]----------------| 0
    //   31|Cr8[1:0]|-----------------Y9[9:0]--------------|----Cb8[9:6]----| 16
    //   47|--------Cb10[5:0]------|----------------Y10[9:0]----------------| 32
    //   63|Cr10[1:0|-----------------Y11[9:0]-------------|---Cb10[9:6]----| 48
    //   79|--------Cb12[5:0]------|----------------Y12[9:0]----------------| 64
    //   95|Cr12[1:0|----------------Y13[9:0]--------------|---Cb12[9:6]----| 80
    //  111|--------Cb14[5:0]------|----------------Y14[9:0]----------------| 96
    //  127|Cr14[1:0|----------------Y15[9:0]--------------|---Cb14[9:6]----| 112
    __m128i CbCr1 = _mm_blend_epi16(ss2, ss3, 0x0F);
    // bits| 15  14  13  12  11  10  09  08  07  06  05  04  03  02  01  00 |
    //   15|----Y5[3:0]----|---------------Cb12[9:0]---------------|Y12[9:8]| 0
    //   31|----Y15[3:0]---|---------------Cb14[9:0]---------------|Y14[9:8]| 16
    //   47|---------Cr12[9:2]-------------|---------Cr12[9:2]--------------| 32
    //   63|---------Cr14[9:2]-------------|---------Cr14[9:2]--------------| 48
    //   79|----Y9[3:0]----|----------------Cb8[9:0]---------------|-Y8[9:8]| 64
    //   95|----Y11[3:0]---|----------------Cb10[9:0]--------------|Y10[9:8]| 80
    //  111|---------Cr8[9:2]--------------|---------Cr8[9:2]---------------| 96
    //  127|---------Cr10[9:2]-------------|---------Cr10[9:2]--------------| 112

    static const uint16_t Y_SCALE[8] = {1<<14,1<<10, 1<<14,1<<10, 1<<14,1<<10, 1<<14,1<<10, };
    __m128i yScale;
    memcpy(&yScale, Y_SCALE, sizeof(__m128i));
    Y0  = _mm_mulhi_epu16(Y0, yScale);
    // bits| 15  14  13  12  11  10  09  08  07  06  05  04  03  02  01  00 |
    //   15|---00---|-------Cb0[5:0]--------|------------Y0[9:2]------------| 0
    //   31|-----------00----------|Cr0[1:0]|------------Y1[9:0]------------| 16
    //   47|---00---|-------Cb2[5:0]--------|------------Y2[9:2]------------| 32
    //   63|-----------00----------|Cr2[1:0]|------------Y3[9:0]------------| 48
    //   79|---00---|-------Cb4[5:0]--------|------------Y4[9:2]------------| 64
    //   95|-----------00----------|Cr4[1:0]|------------Y5[9:0]------------| 80
    //  111|---00---|-------Cb6[5:0]--------|------------Y6[9:2]------------| 96
    //  127|-----------00----------|Cr6[1:0]|------------Y7[9:0]------------| 112
    Y1  = _mm_mulhi_epu16(Y1, yScale);
    // bits| 15  14  13  12  11  10  09  08  07  06  05  04  03  02  01  00 |
    //   15|---00---|-------Cb8[5:0]--------|------------Y8[9:2]------------| 0
    //   31|-----------00----------|Cr8[1:0]|------------Y9[9:0]------------| 16
    //   47|---00---|------Cb10[5:0]--------|-----------Y10[9:2]------------| 32
    //   63|-----------00----------|Cr10[1:0|-----------Y11[9:0]------------| 48
    //   79|---00---|------Cb12[5:0]--------|-----------Y12[9:2]------------| 64
    //   95|-----------00----------|Cr12[1:0|-----------Y13[9:0]------------| 80
    //  111|---00---|------Cb14[5:0]--------|-----------Y14[9:2]------------| 96
    //  127|-----------00----------|Cr14[1:0|-----------Y15[9:0]------------| 112
    __m128i Cb0 = _mm_srli_epi16(CbCr0, 4);
    // bits| 15  14  13  12  11  10  09  08  07  06  05  04  03  02  01  00 |
    //   15|-------00-------|------Y5[3:0]--|-----------Cb4[9:2]------------| 0
    //   31|-------00-------|------Y7[3:0]--|-----------Cb6[9:2]------------| 16
    //   47|-------00-------|---------Cr4[9:2]--------------|--Cr4[9:6]-----| 32
    //   63|-------00-------|---------Cr6[9:2]--------------|--Cr6[9:6]-----| 48
    //   79|-------00-------|------Y1[3:0]--|-----------Cb0[9:2]------------| 64
    //   95|-------00-------|------Y3[3:0]--|-----------Cb2[9:2]------------| 80
    //  111|-------00-------|---------Cr0[9:2]--------------|--Cr0[9:6]-----| 96
    //  127|-------00-------|---------Cr2[9:2]--------------|--Cr2[9:6]-----| 112
    __m128i Cb1 = _mm_srli_epi16(CbCr1, 4);
    // bits| 15  14  13  12  11  10  09  08  07  06  05  04  03  02  01  00 |
    //   15|-------00-------|----Y5[3:0]----|------------Cb12[9:2]----------| 0
    //   31|-------00-------|----Y15[3:0]---|------------Cb14[9:2]----------| 16
    //   47|-------00-------|---------Cr12[9:2]-------------|----Cr12[9:2]--| 32
    //   63|-------00-------|---------Cr14[9:2]-------------|----Cr14[9:2]--| 48
    //   79|-------00-------|----Y9[3:0]----|------------Cb8[9:2]-----------| 64
    //   95|-------00-------|----Y11[3:0]---|------------Cb10[9:2]----------| 80
    //  111|-------00-------|---------Cr8[9:2]--------------|----Cr8[9:2]---| 96
    //  127|-------00-------|---------Cr10[9:2]-------------|----Cr10[9:2]--| 112

    static const uint8_t Y_IDX[16] = {0,2,4,6, 8,10,12,14, 0,2,4,6, 8,10,12,14,};
    __m128i yIdx;
    memcpy(&yIdx, Y_IDX, sizeof(__m128i));
    Y0 = _mm_shuffle_epi8(Y0, yIdx);
    // bits| 15  14  13  12  11  10  09  08  07  06  05  04  03  02  01  00 |
    //   15|------------Y1[9:2]-------------|------------Y0[9:2]------------| 0
    //   31|------------Y3[9:0]-------------|------------Y2[9:0]------------| 16
    //   47|------------Y5[9:2]-------------|------------Y4[9:2]------------| 32
    //   63|------------Y7[9:0]-------------|------------Y6[9:0]------------| 48
    //   79|------------Y1[9:2]-------------|------------Y0[9:2]------------| 64
    //   95|------------Y3[9:0]-------------|------------Y2[9:0]------------| 80
    //  111|------------Y5[9:2]-------------|------------Y4[9:2]------------| 96
    //  127|------------Y7[9:0]-------------|------------Y6[9:0]------------| 112
    Y1 = _mm_shuffle_epi8(Y1, yIdx);
    // bits| 15  14  13  12  11  10  09  08  07  06  05  04  03  02  01  00 |
    //   15|------------Y9[9:2]-------------|------------Y8[9:2]------------| 0
    //   31|-----------Y11[9:0]-------------|-----------Y10[9:0]------------| 16
    //   47|-----------Y13[9:2]-------------|-----------Y12[9:2]------------| 32
    //   63|-----------Y15[9:0]-------------|-----------Y14[9:0]------------| 48
    //   79|------------Y9[9:2]-------------|------------Y8[9:2]------------| 64
    //   95|-----------Y11[9:0]-------------|-----------Y10[9:0]------------| 80
    //  111|-----------Y13[9:2]-------------|-----------Y12[9:2]------------| 96
    //  127|-----------Y15[9:0]-------------|-----------Y14[9:0]------------| 112
    __m128i Y = _mm_blend_epi16(Y0, Y1, 0xF0);
    // bits| 15  14  13  12  11  10  09  08  07  06  05  04  03  02  01  00 |
    //   15|------------Y1[9:2]-------------|------------Y0[9:2]------------| 0
    //   31|------------Y3[9:0]-------------|------------Y2[9:0]------------| 16
    //   47|------------Y5[9:2]-------------|------------Y4[9:2]------------| 32
    //   63|------------Y7[9:0]-------------|------------Y6[9:0]------------| 48
    //   79|------------Y9[9:2]-------------|------------Y8[9:2]------------| 64
    //   95|-----------Y11[9:0]-------------|-----------Y10[9:0]------------| 80
    //  111|-----------Y13[9:2]-------------|-----------Y12[9:2]------------| 96
    //  127|-----------Y15[9:0]-------------|-----------Y14[9:0]------------| 112
    
    static const uint8_t CB_IDX[16] = {8,8,10,10, 0,0,2,2, 8,8,10,10, 0,0,2,2};
    __m128i cbIdx;
    memcpy(&cbIdx, CB_IDX, sizeof(__m128i));
    Cb0 = _mm_shuffle_epi8(Cb0, cbIdx);
    // bits| 15  14  13  12  11  10  09  08  07  06  05  04  03  02  01  00 |
    //   15|-----------Cb0[9:2]-------------|-----------Cb0[9:2]------------| 0
    //   31|-----------Cb2[9:2]-------------|-----------Cb2[9:2]------------| 16
    //   47|-----------Cb4[9:2]-------------|-----------Cb4[9:2]------------| 32
    //   63|-----------Cb6[9:2]-------------|-----------Cb6[9:2]------------| 48
    //   79|-----------Cb0[9:2]-------------|-----------Cb0[9:2]------------| 64
    //   95|-----------Cb2[9:2]-------------|-----------Cb2[9:2]------------| 80
    //  111|-----------Cb4[9:2]-------------|-----------Cb4[9:2]------------| 96
    //  127|-----------Cb6[9:2]-------------|-----------Cb6[9:2]------------| 112
    Cb1 = _mm_shuffle_epi8(Cb1, cbIdx);
    // bits| 15  14  13  12  11  10  09  08  07  06  05  04  03  02  01  00 |
    //   15|-----------Cb8[9:2]-------------|-----------Cb12[9:2]-----------| 0
    //   31|-----------Cb10[9:2]------------|-----------Cb14[9:2]-----------| 16
    //   47|-----------Cb12[9:2]------------|-----------Cb12[9:2]-----------| 32
    //   63|-----------Cb14[9:2]------------|-----------Cb14[9:2]-----------| 48
    //   79|-----------Cb8[9:2]-------------|-----------Cb12[9:2]-----------| 64
    //   95|-----------Cb10[9:2]------------|-----------Cb14[9:2]-----------| 80
    //  111|-----------Cb12[9:2]------------|-----------Cb12[9:2]-----------| 96
    //  127|-----------Cb14[9:2]------------|-----------Cb14[9:2]-----------| 112
    __m128i Cb = _mm_blend_epi16(Cb0, Cb1, 0xF0);
    // bits| 15  14  13  12  11  10  09  08  07  06  05  04  03  02  01  00 |
    //   15|-----------Cb0[9:2]-------------|-----------Cb0[9:2]------------| 0
    //   31|-----------Cb2[9:2]-------------|-----------Cb2[9:2]------------| 16
    //   47|-----------Cb4[9:2]-------------|-----------Cb4[9:2]------------| 32
    //   63|-----------Cb6[9:2]-------------|-----------Cb6[9:2]------------| 48
    //   79|-----------Cb8[9:2]-------------|-----------Cb12[9:2]-----------| 64
    //   95|-----------Cb10[9:2]------------|-----------Cb14[9:2]-----------| 80
    //  111|-----------Cb12[9:2]------------|-----------Cb12[9:2]-----------| 96
    //  127|-----------Cb14[9:2]------------|-----------Cb14[9:2]-----------| 112
    
    static const uint8_t CR_IDX[16] = {12,12,14,14, 4,4,6,6, 12,12,14,14, 4,4,6,6};
    __m128i crIdx;
    memcpy(&crIdx, CR_IDX, sizeof(__m128i));
    __m128i Cr0 = _mm_shuffle_epi8(CbCr0, crIdx);
    // bits| 15  14  13  12  11  10  09  08  07  06  05  04  03  02  01  00 |
    //   15|-----------Cr0[9:2]-------------|-----------Cr0[9:2]------------| 0
    //   31|-----------Cr2[9:2]-------------|-----------Cr2[9:2]------------| 16
    //   47|-----------Cr4[9:2]-------------|-----------Cr4[9:2]------------| 32
    //   63|-----------Cr6[9:2]-------------|-----------Cr6[9:2]------------| 48
    //   79|-----------Cr0[9:2]-------------|-----------Cr0[9:2]------------| 64
    //   95|-----------Cr2[9:2]-------------|-----------Cr2[9:2]------------| 80
    //  111|-----------Cr4[9:2]-------------|-----------Cr4[9:2]------------| 96
    //  127|-----------Cr6[9:2]-------------|-----------Cr6[9:2]------------| 112
    __m128i Cr1 = _mm_shuffle_epi8(CbCr1, crIdx);
    // bits| 15  14  13  12  11  10  09  08  07  06  05  04  03  02  01  00 |
    //   15|-----------Cr8[9:2]-------------|-----------Cr12[9:2]-----------| 0
    //   31|-----------Cr10[9:2]------------|-----------Cr14[9:2]-----------| 16
    //   47|-----------Cr12[9:2]------------|-----------Cr12[9:2]-----------| 32
    //   63|-----------Cr14[9:2]------------|-----------Cr14[9:2]-----------| 48
    //   79|-----------Cr8[9:2]-------------|-----------Cr12[9:2]-----------| 64
    //   95|-----------Cr10[9:2]------------|-----------Cr14[9:2]-----------| 80
    //  111|-----------Cr12[9:2]------------|-----------Cr12[9:2]-----------| 96
    //  127|-----------Cr14[9:2]------------|-----------Cr14[9:2]-----------| 112
    __m128i Cr = _mm_blend_epi16(Cr0, Cr1, 0xF0);
    // bits| 15  14  13  12  11  10  09  08  07  06  05  04  03  02  01  00 |
    //   15|-----------Cb0[9:2]-------------|-----------Cb0[9:2]------------| 0
    //   31|-----------Cb2[9:2]-------------|-----------Cb2[9:2]------------| 16
    //   47|-----------Cb4[9:2]-------------|-----------Cb4[9:2]------------| 32
    //   63|-----------Cb6[9:2]-------------|-----------Cb6[9:2]------------| 48
    //   79|-----------Cr8[9:2]-------------|-----------Cr12[9:2]-----------| 64
    //   95|-----------Cr10[9:2]------------|-----------Cr14[9:2]-----------| 80
    //  111|-----------Cr12[9:2]------------|-----------Cr12[9:2]-----------| 96
    //  127|-----------Cr14[9:2]------------|-----------Cr14[9:2]-----------| 112
    
    memcpy(&dst0[i*4+0], &Y, sizeof(__m128i));
    memcpy(&dst1[i*4+0], &Cb, sizeof(__m128i));
    memcpy(&dst2[i*4+0], &Cr, sizeof(__m128i));
    

    memcpy(&s3, &src[6], sizeof(__m128i));
    memcpy(&s4, &src[8], sizeof(__m128i));

    __m128i ss0l = _mm_bsrli_si128(s2, 8);
    __m128i ss0h = _mm_bslli_si128(s3, 8);
    ss0  = _mm_castps_si128(_mm_or_ps(_mm_castsi128_ps(ss0l), _mm_castsi128_ps(ss0h)));
    ss1  = _mm_bsrli_si128(s3, 2);
    __m128i ss2l = _mm_bsrli_si128(s3, 12);
    __m128i ss2h = _mm_bslli_si128(s4, 4);
    ss2  = _mm_castps_si128(_mm_or_ps(_mm_castsi128_ps(ss2l), _mm_castsi128_ps(ss2h)));
    ss3  = _mm_bsrli_si128(s4, 6);



    ss0 = _mm_shuffle_epi8(ss0, ssIdx0);
    ss1 = _mm_shuffle_epi8(ss1, ssIdx1);
    ss2 = _mm_shuffle_epi8(ss2, ssIdx0);
    ss3 = _mm_shuffle_epi8(ss3, ssIdx1);

    Y0    = _mm_blend_epi16(ss0, ss1, 0xF0);
    CbCr0 = _mm_blend_epi16(ss0, ss1, 0x0F);
    Y1    = _mm_blend_epi16(ss2, ss3, 0xF0);
    CbCr1 = _mm_blend_epi16(ss2, ss3, 0x0F);

    
    Y0  = _mm_mulhi_epu16(Y0, yScale);
    Y1  = _mm_mulhi_epu16(Y1, yScale);
    Cb0 = _mm_srli_epi16(CbCr0, 4);
    Cb1 = _mm_srli_epi16(CbCr1, 4);

    Y0 = _mm_shuffle_epi8(Y0, yIdx);
    Y1 = _mm_shuffle_epi8(Y1, yIdx);
    Y  = _mm_blend_epi16(Y0, Y1, 0xF0);
    
    Cb0 = _mm_shuffle_epi8(Cb0, cbIdx);
    Cb1 = _mm_shuffle_epi8(Cb1, cbIdx);
    Cb  = _mm_blend_epi16(Cb0, Cb1, 0xF0);
 
    Cr0 = _mm_shuffle_epi8(CbCr0, crIdx);
    Cr1 = _mm_shuffle_epi8(CbCr1, crIdx);
    Cr  = _mm_blend_epi16(Cr0, Cr1, 0xF0);
 
    memcpy(&dst0[i*4+2], &Y, sizeof(__m128i));
    memcpy(&dst1[i*4+2], &Cb, sizeof(__m128i));
    memcpy(&dst2[i*4+2], &Cr, sizeof(__m128i));
  }
}

static void pp(const void* a,const void* b)
{
  for (int k = 0; k < 2; ++k) {
    for (int i = 0; i < 32; ++i)
      printf("%02x%c", ((uint8_t*)a)[k*32+i], i==31 ? '\n' : i%4==3 ? ' ' : '-');
    for (int i = 0; i < 32; ++i)
      printf("%02x%c", ((uint8_t*)b)[k*32+i], i==31 ? '\n' : i%4==3 ? ' ' : '-');
    for (int i = 0; i < 32; ++i)
      printf("%s%c", ((uint8_t*)a)[k*32+i]==((uint8_t*)b)[k*32+i] ? ".." : "^^", i==31 ? '\n' : i%4==3 ? ' ' : '-');
  }
}